version: '1.0'

steps:

  resolve_chart_folder:
    title: resolve chart folder name
    image: alpine:3.7
    commands:
    # find folder with Chart.yaml and get it's name
    - cf_export CHART_NAME=$(find . -name "Chart.yaml" | awk -F '[/]' '{print $2}')

  package_chart:
    title: package chart
    image: codefresh/plugin-helm:2.8.1
    commands:
    - helm init --client-only
    - helm package -u $CHART_NAME

  update_chart_repo:
    title: update chart in repository
    image: codefresh/plugin-helm:2.8.1
    commands:
    - "VERSION=$(grep \"version: \" $CHART_NAME/Chart.yaml | awk '{print $2}')"
    - PACKAGE=$CHART_NAME-$VERSION.tgz
    - curl -X POST --user ${{BASIC_AUTH_USER}}:${{BASIC_AUTH_PASS}} --fail --data-binary "@$PACKAGE" ${{HELM_REPO_PATH}}
